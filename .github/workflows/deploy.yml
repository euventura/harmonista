name: Deploy to Production

on:
  push:
    branches:
      - master  # Dispara quando houver push na branch master
  workflow_dispatch:  # Permite execução manual pelo GitHub

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'  # Corresponde à versão no go.mod
          cache: true

      - name: Download dependencies
        run: |
          echo "Downloading Go dependencies..."
          go mod download
          go mod verify

      - name: Build application
        run: |
          echo "Building Harmonista..."
          GO111MODULE=on go build -o harmonista .
          chmod +x harmonista

      - name: Create deployment directory structure
        run: |
          mkdir -p deploy
          cp harmonista deploy/
          cp harmonista.service deploy/

          # Copiar diretórios necessários mantendo estrutura
          for dir in public admin/views site/views blog/views; do
            if [ -d "$dir" ]; then
              echo "Copying $dir..."
              mkdir -p "deploy/$(dirname $dir)"
              cp -r "$dir" "deploy/$dir"
            fi
          done

          # Verificar estrutura criada
          echo "Deployment structure:"
          ls -la deploy/
          find deploy/ -type d

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Instalar sshpass
          sudo apt-get update
          sudo apt-get install -y sshpass

          # Criar diretório remoto
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "sudo mkdir -p /var/www/harmonista && sudo chown -R $SSH_USER:$SSH_USER /var/www/harmonista"

          # Parar o serviço
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "sudo systemctl stop harmonista 2>/dev/null || true"

          # Enviar todos os arquivos e diretórios
          echo "Uploading application files..."
          sshpass -p "$SSH_PASSWORD" scp -r -o StrictHostKeyChecking=no \
            deploy/* "$SSH_USER@$SSH_HOST:/var/www/harmonista/"

          # Verificar estrutura no servidor
          echo "Verifying deployment structure on server:"
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "ls -la /var/www/harmonista/ && echo '---' && find /var/www/harmonista -type d | head -20"

      - name: Upload systemd service file
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            harmonista.service "$SSH_USER@$SSH_HOST:/tmp/harmonista.service"

      - name: Verify deployment requirements
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "Verifying deployment requirements..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash << 'VERIFY'
          set -e

          # Verificar .env
          if [ ! -f /var/www/harmonista/.env ]; then
            echo "❌ ERROR: .env file not found at /var/www/harmonista/.env"
            echo "Please create the .env file on the server before deploying."
            echo "See DEPLOY.md for instructions."
            exit 1
          else
            echo "✅ .env file found"
          fi

          # Verificar binário
          if [ ! -f /var/www/harmonista/harmonista ]; then
            echo "❌ ERROR: harmonista binary not found"
            exit 1
          else
            echo "✅ Binary found"
          fi

          # Verificar diretórios de views
          for dir in admin/views site/views blog/views; do
            if [ ! -d "/var/www/harmonista/$dir" ]; then
              echo "❌ ERROR: Required directory not found: $dir"
              exit 1
            else
              echo "✅ Directory found: $dir"
            fi
          done

          # Verificar public
          if [ ! -d /var/www/harmonista/public ]; then
            echo "⚠️  WARNING: public directory not found"
          else
            echo "✅ Public directory found"
          fi

          echo ""
          echo "All requirements verified successfully!"
          VERIFY

      - name: Configure and start service
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            'sudo chown -R www-data:www-data /var/www/harmonista && \
             sudo chmod +x /var/www/harmonista/harmonista && \
             sudo setcap cap_net_bind_service=+ep /var/www/harmonista/harmonista && \
             sudo chmod 600 /var/www/harmonista/.env && \
             sudo mv /tmp/harmonista.service /etc/systemd/system/harmonista.service && \
             sudo systemctl daemon-reload && \
             sudo systemctl enable harmonista && \
             sudo systemctl restart harmonista && \
             sleep 3'

      - name: Check service status
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "Checking service status..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            'sudo systemctl status harmonista --no-pager || true'

          echo ""
          echo "Recent logs:"
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            'sudo journalctl -u harmonista -n 50 --no-pager'

          echo ""
          echo "Checking if service is active..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            'if sudo systemctl is-active --quiet harmonista; then \
               echo "✅ Service is running successfully!"; \
               exit 0; \
             else \
               echo "❌ Service failed to start. Check the logs above."; \
               exit 1; \
             fi'

      - name: Deployment complete
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Application deployed to: /var/www/harmonista"
