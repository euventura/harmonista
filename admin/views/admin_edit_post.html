{{ template "admin_header.html" .}}

{{ template "tinymde_component.html" .}}

<section>
    <header>
        <h2>Editar Post</h2>
    </header>

    {{if .post}}
    <section>
        {{ domain }}/@/{{$.subdomain}}/{{ .Slug }} <br/>
        <small>
            <strong>ID:</strong> {{.post.ID}} |
            <strong>Criado em:</strong> {{.post.CreatedAt.Format "02/01/2006 15:04"}} |
            <strong>Atualizado em:</strong> {{.post.UpdatedAt.Format "02/01/2006 15:04"}} |
            <strong>Visitas:</strong> {{.visitCount}}
        </small>
    </section>

    <form action="/admin/{{.subdomain}}/post/{{.post.ID}}" method="POST">
        <label for="title" class="width">
            Título
            <input type="text" id="title" name="title" value="{{.post.Title}}" required>
        </label>

        <label for="category" class="width">
            Tags
            <input type="text" id="tags" name="tags">
        </label>

        <label for="txt_content" class="width">
            Conteúdo (<a href="https://markdown.net.br/referencia-rapida/" target="_blank">Markdown</a>)
            <small>Dica: Use Ctrl+R para visualizar o markdown renderizado • F11 para tela cheia</small>
        </label>
        <textarea id="txt_content" name="content" rows="20" required style="font-family: 'Courier New', monospace; white-space: pre-wrap;"> {{.post.Content}}</textarea>

        <section>
            <input type="hidden" id="draft" name="draft" value="{{if .post.Draft}}true{{else}}false{{end}}">

            {{if .post.Draft}}
            <button type="submit" name="action" value="save">Salvar</button>
            <button type="submit" name="action" value="publish">Publicar</button>
            {{else}}
            <button type="submit" name="action" value="unpublish">Despublicar</button>
            <button type="submit" name="action" value="update">Atualizar</button>
            {{end}}
            <button type="button" onclick="deletePost({{.post.ID}})">Deletar</button>
            <button type="button" onclick="window.location.href='/admin/{{.subdomain}}/posts'">Cancelar</button>
        </section>
    </form>
    {{else}}
    <p>Post não encontrado.</p>
    {{end}}
</section>

<script>
    // Inicializar TinyMDE com auto-save apenas se for rascunho
    const isDraft = {{.post.Draft}};
    const tinyMDEManager = new TinyMDEManager({
        textareaId: 'txt_content',
        autoSave: isDraft,
        autoSaveUrl: '/admin/{{.subdomain}}/post/{{.post.ID}}/autosave',
        autoSaveKey: 'edit_post_{{.post.ID}}'
    });

    const subdomain = '{{.subdomain}}';

    const saveBtn = document.querySelector('button[value="save"]');
    const publishBtn = document.querySelector('button[value="publish"]');
    const unpublishBtn = document.querySelector('button[value="unpublish"]');
    const updateBtn = document.querySelector('button[value="update"]');

    if (saveBtn) {
        saveBtn.addEventListener('click', function () {
            document.getElementById('draft').value = 'true';
        });
    }

    if (publishBtn) {
        publishBtn.addEventListener('click', function () {
            document.getElementById('draft').value = 'false';
        });
    }

    if (unpublishBtn) {
        unpublishBtn.addEventListener('click', function () {
            document.getElementById('draft').value = 'true';
        });
    }

    if (updateBtn) {
        updateBtn.addEventListener('click', function () {
            document.getElementById('draft').value = 'false';
        });
    }

    function deletePost(id) {
        if (!confirm('Tem certeza que deseja deletar este post? Esta ação não pode ser desfeita.')) {
            return;
        }

        fetch('/admin/' + subdomain + '/post/' + id, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    alert('Post deletado com sucesso!');
                    window.location.href = '/admin/' + subdomain + '/posts';
                } else {
                    return response.json().then(data => {
                        alert('Erro ao deletar post: ' + (data.error || 'Erro desconhecido'));
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao deletar post: ' + error);
            });
    }
</script>

{{ template "admin_footer.html" .}}
